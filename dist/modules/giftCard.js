"use strict";function GiftCard(a){this.logger=a,this.config={}}var _=require("lodash"),Q=require("q"),request=require("request"),xmlParser=require("xml2json"),logger=require("yocto-logger"),moment=require("moment");GiftCard.prototype.use=function(a){return this.config=a,!0},GiftCard.prototype.getBalance=function(a,b){var c=[{code:"00"},{code:"02",message:"Carte ou compte bloqué"},{code:"03",message:"VU nombre n'est pas connu"},{code:"30",message:"Requête invalide"},{code:"33",message:"Votre carte à expirée"},{code:"43",message:"Votre carte est inactive"},{code:"55",message:"Votre code pin est invalide"},{code:"56",message:"Carte Inconnue"},{code:"91",message:"Erreur interne au système"},{code:"-1",message:"Impossible de connaitre votre solde"}],d=Q.defer(),e=moment(),f=moment().unix(),g={MessageType:200,CardNumber:a,RequestType:"00",Amount:0,TraceNumber:f,Time:e.format("hhmmss"),Date:e.format("MMDD"),expiryDate:4912,entryMode:"03",Pin:b,PinLength:_.size(b),Condition:"00","Terminal-ID":99999999,"Branch-ID":777777,Currency:978,Sequence:f};return request.post({uri:[this.config.uri,"DoTransactionProcessing"].join("/"),form:g},function(a,b,e){if(a||200!==b.statusCode)d.reject(a);else{var f=xmlParser.toJson(e,{object:!0,trim:!0});if(_.has(f,"AutSys.Reply")){var g=_.get(f,"AutSys.Reply");if(_.has(g,"ResponseCode")){var h=_.get(g,"ResponseCode"),i=_.first(_.values(_.pickBy(c,function(a){return a.code===h})));if("00"===h)return console.log(_.get(g,"Message")),process.exit(0);this.logger.error(["[ Ingenico.giftCard.GetBalance ] -","Invalid response code retreive from GetBalance call. Code :",h,"- Message :",_.get(i,"message")||_.get(g,"Message")].join(" ")),d.reject({code:_.isString(h)||_.isNumber(h)?h:"Unkown Code",message:_.get(i,"message")||_.get(g,"Message")})}else d.reject(["Cannot retrive reponse code from response :",e].join(" "))}else d.reject(["Invalid format retreive from GetBalance call",f].join(" "))}}.bind(this)),d.promise},module.exports=function(a){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ Ingenico.GiftCard.constructor ] - Invalid logger given. Use internal logger"),a=logger),new GiftCard(a)};
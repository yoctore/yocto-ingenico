"use strict";function GiftCard(a){this.logger=a,this.config={}}var _=require("lodash"),Q=require("q"),request=require("request"),xmlParser=require("xml2json"),logger=require("yocto-logger");GiftCard.prototype.use=function(a){return this.config=a,!0},GiftCard.prototype.getBalance=function(a,b){var c=[{code:"00"},{code:"02",message:"Carte ou compte bloqué"},{code:"30",message:"Requête invalide"},{code:"33",message:"Votre carte à expirée"},{code:"43",message:"Votre carte est inactive"},{code:"55",message:"Votre code pin est invalide"},{code:"56",message:"Carte Inconnue"},{code:"91",message:"Erreur interne au système"},{code:"-1",message:"Impossible de connaitre votre solde"}],d=Q.defer();return request({method:"GET",uri:[this.config.uri,"GetBalance"].join("/"),qs:{CardNumber:a,Pin:b}},function(a,b,e){if(a||200!==b.statusCode)d.reject(a);else{var f=xmlParser.toJson(e,{object:!0,trim:!0});if(_.has(f,"AutSys.Reply")){var g=_.get(f,"AutSys.Reply");if(_.has(g,"ResponseCode")){var h=_.get(g,"ResponseCode"),i=_.first(_.values(_.pickBy(c,function(a){return a.code===h})));"00"!==h?d.reject(["Invalid response code retreive from GetBalance call. Code :",h,"- Message :",i.message].join(" ")):d.resolve(g)}else d.reject(["Cannot retrive reponse code from response :",e].join(" "))}else d.reject(["Invalid format retreive from GetBalance call",f].join(" "))}}),d.promise},module.exports=function(a){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ Ingenico.GiftCard.constructor ] - Invalid logger given. Use internal logger"),a=logger),new GiftCard(a)};